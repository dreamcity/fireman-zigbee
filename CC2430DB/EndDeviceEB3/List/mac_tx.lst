###############################################################################
#                                                                             #
# IAR 8051 C/C++ Compiler V7.30B/W32                    18/Mar/2013  18:21:58 #
# Copyright 2004-2007 IAR Systems. All rights reserved.                       #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data                                               #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-1.4.3-1.2.1\Components #
#                          \mac\low_level\srf03\mac_tx.c                      #
#    Command line       =  -f "C:\Texas Instruments\ZStack-1.4.3-1.2.1\Projec #
#                          ts\zstack\Samples\cc2430-zstack-adxl345\CC2430DB\. #
#                          .\..\..\Tools\CC2430DB\f8wEndev.cfg" (-DCPU32MHZ   #
#                          -DFORCE_MAC_NEAR -DROOT=__near_func                #
#                          -DMAC_OPT_FFD=0 -DBLINK_LEDS "-DCONST=const        #
#                          __code" -DGENERIC=__generic) -f "C:\Texas          #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\Tools #
#                          \CC2430DB\f8wConfig.cfg" (-DSECURE=0               #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=10 -DAPSC_MAX_FRAME_RETRIES=3   #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=20           #
#                          -DNWK_MAX_BINDING_ENTRIES=10                       #
#                          -DMAX_BINDING_CLUSTER_IDS=5 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "C:\Texas                   #
#                          Instruments\ZStack-1.4.3-1.2.1\Components\mac\low_ #
#                          level\srf03\mac_tx.c" -D CC2430EB -D AXD_END3 -D   #
#                          NWK_AUTO_POLL -D REFLECTOR -D xZTOOL_P1 -D         #
#                          xMT_TASK -D xMT_ZDO_FUNC -D xLCD_SUPPORTED=DEBUG   #
#                          -D xPOWER_SAVING -lC "C:\Texas                     #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\EndDeviceEB3\L #
#                          ist\" -lA "C:\Texas Instruments\ZStack-1.4.3-1.2.1 #
#                          \Projects\zstack\Samples\cc2430-zstack-adxl345\CC2 #
#                          430DB\EndDeviceEB3\List\" --diag_suppress          #
#                          Pe001,Pa010 --diag_remark pe550 -o "C:\Texas       #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\EndDeviceEB3\O #
#                          bj\" -e --require_prototypes -z2 --no_cse          #
#                          --no_unroll --no_inline --no_code_motion           #
#                          --no_tbaa --debug --core=plain --dptr=16,1         #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data --nr_virtual_regs 8 -I      #
#                          "C:\Texas Instruments\ZStack-1.4.3-1.2.1\Projects\ #
#                          zstack\Samples\cc2430-zstack-adxl345\CC2430DB\"    #
#                          -I "C:\Texas Instruments\ZStack-1.4.3-1.2.1\Projec #
#                          ts\zstack\Samples\cc2430-zstack-adxl345\CC2430DB\. #
#                          .\SOURCE\" -I "C:\Texas Instruments\ZStack-1.4.3-1 #
#                          .2.1\Projects\zstack\Samples\cc2430-zstack-adxl345 #
#                          \CC2430DB\..\Drivers\" -I "C:\Texas                #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\ZMAIN #
#                          \TI2430DB\" -I "C:\Texas                           #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\MT\" -I "C:\Texas                      #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\HAL\INCLUDE\" -I "C:\Texas             #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\HAL\TARGET\CC2430EB\" -I "C:\Texas     #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\OSAL\MCU\CCSOC\" -I "C:\Texas          #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\OSAL\INCLUDE\" -I "C:\Texas            #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\STACK\AF\" -I "C:\Texas                #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\STACK\NWK\" -I "C:\Texas               #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\STACK\SEC\" -I "C:\Texas               #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\STACK\SYS\" -I "C:\Texas               #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\STACK\ZDO\" -I "C:\Texas               #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\ZMAC\F8W\" -I "C:\Texas                #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\ZMAC\" -I "C:\Texas                    #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\SERVICES\SADDR\" -I "C:\Texas          #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\SERVICES\SDATA\" -I "C:\Texas          #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\MAC\INCLUDE\" -I "C:\Texas             #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\MAC\HIGH_LEVEL\" -I "C:\Texas          #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\MAC\LOW_LEVEL\SRF03\" -I "C:\Texas     #
#                          Instruments\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\cc2430-zstack-adxl345\CC2430DB\..\..\..\..\.. #
#                          \COMPONENTS\MAC\LOW_LEVEL\SRF03\SINGLE_CHIP\" -I   #
#                          "C:\Program Files\IAR Systems\Embedded Workbench   #
#                          4.0 Evaluation version\8051\INC\" -I "C:\Program   #
#                          Files\IAR Systems\Embedded Workbench 4.0           #
#                          Evaluation version\8051\INC\CLIB\"                 #
#    List file          =  C:\Texas Instruments\ZStack-1.4.3-1.2.1\Projects\z #
#                          stack\Samples\cc2430-zstack-adxl345\CC2430DB\EndDe #
#                          viceEB3\List\mac_tx.lst                            #
#    Object file        =  C:\Texas Instruments\ZStack-1.4.3-1.2.1\Projects\z #
#                          stack\Samples\cc2430-zstack-adxl345\CC2430DB\EndDe #
#                          viceEB3\Obj\mac_tx.r51                             #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-1.4.3-1.2.1\Components\mac\low_level\srf03\mac_tx.c
      1          /**************************************************************************************************
      2            Filename:       mac_tx.c
      3            Revised:        $Date: 2007-10-29 22:38:47 -0700 (Mon, 29 Oct 2007) $
      4            Revision:       $Revision: 15812 $
      5          
      6            Description:    Describe the purpose and contents of the file.
      7          
      8          
      9            Copyright 2006-2007 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          /* ------------------------------------------------------------------------------------------------
     41           *                                          Includes
     42           * ------------------------------------------------------------------------------------------------
     43           */
     44          
     45          /* hal */
     46          #include "hal_types.h"
     47          #include "hal_defs.h"
     48          #include "hal_mcu.h"

   \                                 In  segment SFR_AN, at 0x91
   \   unsigned char volatile __sfr RFIM
   \                     RFIM:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xa8
   \   union <unnamed> volatile __sfr _A_IEN0
   \                     _A_IEN0:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xe1
   \   unsigned char volatile __sfr RFST
   \                     RFST:
   \   000000                DS 1
     49          #include "hal_mac_cfg.h"
     50          
     51          /* high-level */
     52          #include "mac_spec.h"
     53          #include "mac_pib.h"
     54          
     55          /* exported low-level */
     56          #include "mac_low_level.h"
     57          
     58          /* low-level specific */
     59          #include "mac_tx.h"
     60          #include "mac_backoff_timer.h"
     61          #include "mac_rx.h"
     62          #include "mac_rx_onoff.h"
     63          #include "mac_radio.h"
     64          #include "mac_sleep.h"
     65          
     66          /* target specific */
     67          #include "mac_radio_defs.h"
     68          
     69          /* debug */
     70          #include "mac_assert.h"
     71          
     72          
     73          /* ------------------------------------------------------------------------------------------------
     74           *                                            Defines
     75           * ------------------------------------------------------------------------------------------------
     76           */
     77          #define MFR_LEN                   MAC_FCS_FIELD_LEN
     78          #define PREPENDED_BYTE_LEN        1
     79          
     80          
     81          /* ------------------------------------------------------------------------------------------------
     82           *                                         Global Constants
     83           * ------------------------------------------------------------------------------------------------
     84           */
     85          
     86          /*
     87           *  This is the time, in backoffs, required to set up a slotted transmit.
     88           *  It is exported to high level so that code can schedule enough time
     89           *  for slotted transmits.
     90           *
     91           *  A default is provided if a value is not specified.  If the default
     92           *  is not appropriate, a #define should be added within hal_mac_cfg.h.
     93           */
     94          #ifndef HAL_MAC_TX_SLOTTED_DELAY
     95          #define HAL_MAC_TX_SLOTTED_DELAY    3
     96          #endif

   \                                 In  segment XDATA_I, align 1, keep-with-next
     97          uint8 const macTxSlottedDelay = HAL_MAC_TX_SLOTTED_DELAY;
   \                     macTxSlottedDelay:
   \   000000                DS 1
   \   000001                REQUIRE `?<Initializer for macTxSlottedDelay>`
   \   000001                REQUIRE __INIT_XDATA_I
     98          
     99          
    100          /* ------------------------------------------------------------------------------------------------
    101           *                                         Global Variables
    102           * ------------------------------------------------------------------------------------------------
    103           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    104          uint8 macTxActive;
   \                     macTxActive:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    105          uint8 macTxType;
   \                     macTxType:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    106          uint8 macTxBe;
   \                     macTxBe:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    107          uint8 macTxCsmaBackoffDelay;
   \                     macTxCsmaBackoffDelay:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    108          
    109          
    110          /* ------------------------------------------------------------------------------------------------
    111           *                                         Local Variables
    112           * ------------------------------------------------------------------------------------------------
    113           */

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    114          static uint8 nb;
   \                     nb:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    115          static uint8 txSeqn;
   \                     txSeqn:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    116          static uint8 txAckReq;
   \                     txAckReq:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    117          static uint8 txRetransmitFlag;
   \                     txRetransmitFlag:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    118          
    119          
    120          /* ------------------------------------------------------------------------------------------------
    121           *                                         Local Prototypes
    122           * ------------------------------------------------------------------------------------------------
    123           */
    124          static void txCsmaPrep(void);
    125          static void txGo(void);
    126          static void txCsmaGo(void);
    127          static void txComplete(uint8 status);
    128          
    129          
    130          /**************************************************************************************************
    131           * @fn          macTxInit
    132           *
    133           * @brief       Initialize variables for tx module.
    134           *
    135           * @param       none
    136           *
    137           * @return      none
    138           **************************************************************************************************
    139           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    140          void macTxInit(void)
   \                     macTxInit:
    141          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    142            macTxActive      = MAC_TX_ACTIVE_NO_ACTIVITY;
   \   000004   7400         MOV     A,#0x0
   \   000006   90....       MOV     DPTR,#macTxActive
   \   000009   F0           MOVX    @DPTR,A
    143            txRetransmitFlag = 0;
   \   00000A   7400         MOV     A,#0x0
   \   00000C   90....       MOV     DPTR,#txRetransmitFlag
   \   00000F   F0           MOVX    @DPTR,A
    144          }
   \   000010   D083         POP     DPH
   \   000012   D082         POP     DPL
   \   000014   02....       LJMP    ?BRET
    145          
    146          
    147          /**************************************************************************************************
    148           * @fn          macTxHaltCleanup
    149           *
    150           * @brief       -
    151           *
    152           * @param       none
    153           *
    154           * @return      none
    155           **************************************************************************************************
    156           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    157          void macTxHaltCleanup(void)
   \                     macTxHaltCleanup:
    158          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    159            MAC_RADIO_TX_RESET();
   \   000004                ; Setup parameters for call to function macCspTxReset
   \   000004   12....       LCALL   ??macCspTxReset?relay
    160            macTxInit();
   \   000007                ; Setup parameters for call to function macTxInit
   \   000007   12....       LCALL   ??macTxInit?relay
    161          }
   \   00000A   D083         POP     DPH
   \   00000C   D082         POP     DPL
   \   00000E   02....       LJMP    ?BRET
    162          
    163          
    164          /**************************************************************************************************
    165           * @fn          macTxFrame
    166           *
    167           * @brief       Transmit the frame pointed to by pMacDataTx with the specified type.
    168           *              NOTE! It is not legal to call this function from interrupt context.
    169           *
    170           * @param       txType - type of transmit
    171           *
    172           * @return      none
    173           **************************************************************************************************
    174           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    175          void macTxFrame(uint8 txType)
   \                     macTxFrame:
    176          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
    177            MAC_ASSERT(!macTxActive);            /* transmit on top of transmit */
   \   000007   90....       MOV     DPTR,#macTxActive
   \   00000A   E0           MOVX    A,@DPTR
   \   00000B   6003         JZ      ??macTxFrame_0
   \   00000D                ; Setup parameters for call to function halAssertHandler
   \   00000D   12....       LCALL   ??halAssertHandler?relay
    178          
    179            /* mark transmit as active */
    180            macTxActive = MAC_TX_ACTIVE_INITIALIZE;
   \                     ??macTxFrame_0:
   \   000010   7401         MOV     A,#0x1
   \   000012   90....       MOV     DPTR,#macTxActive
   \   000015   F0           MOVX    @DPTR,A
    181          
    182            /*
    183             *  The MAC will not enter sleep mode if there is an active transmit.  However, if macSleep() is
    184             *  ever called from interrupt context, it possible to enter sleep state after a transmit is
    185             *  intiated but before macTxActive is set.  To recover from this, the transmit must be aborted
    186             *  and proper notificiation given to high-level.
    187             */
    188            if (macSleepState != MAC_SLEEP_STATE_AWAKE)
   \   000016   90....       MOV     DPTR,#macSleepState
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   6008         JZ      ??macTxFrame_1
    189            {
    190              /* notify high-level that transmit had to be aborted */
    191              txComplete(MAC_TX_ABORTED);
   \   00001C                ; Setup parameters for call to function txComplete
   \   00001C   791D         MOV     R1,#0x1d
   \   00001E   12....       LCALL   ??txComplete?relay
    192          
    193              /* exit from transmit logic */
    194              return;
   \   000021   02....       LJMP    ??macTxFrame_2 & 0xFFFF
    195            }
    196            
    197            /* save transmit type */
    198            macTxType = txType;
   \                     ??macTxFrame_1:
   \   000024   E5..         MOV     A,?V0 + 0
   \   000026   90....       MOV     DPTR,#macTxType
   \   000029   F0           MOVX    @DPTR,A
    199          
    200            /*-------------------------------------------------------------------------------
    201             *  Prepare for transmit.
    202             */
    203            if (macTxType == MAC_TX_TYPE_SLOTTED)
   \   00002A   90....       MOV     DPTR,#macTxType
   \   00002D   E0           MOVX    A,@DPTR
   \   00002E   6402         XRL     A,#0x2
   \   000030   7005         JNZ     ??macTxFrame_3
    204            {
    205              MAC_RADIO_TX_PREP_SLOTTED();
   \   000032                ; Setup parameters for call to function macCspTxPrepSlotted
   \   000032   12....       LCALL   ??macCspTxPrepSlotted?relay
   \   000035   8063         SJMP    ??macTxFrame_4
    206            }
    207            else
    208            {
    209              MAC_ASSERT((macTxType == MAC_TX_TYPE_SLOTTED_CSMA) || (macTxType == MAC_TX_TYPE_UNSLOTTED_CSMA));
   \                     ??macTxFrame_3:
   \   000037   90....       MOV     DPTR,#macTxType
   \   00003A   E0           MOVX    A,@DPTR
   \   00003B   600B         JZ      ??macTxFrame_5
   \   00003D   90....       MOV     DPTR,#macTxType
   \   000040   E0           MOVX    A,@DPTR
   \   000041   6401         XRL     A,#0x1
   \   000043   6003         JZ      ??macTxFrame_5
   \   000045                ; Setup parameters for call to function halAssertHandler
   \   000045   12....       LCALL   ??halAssertHandler?relay
    210          
    211              nb = 0;
   \                     ??macTxFrame_5:
   \   000048   7400         MOV     A,#0x0
   \   00004A   90....       MOV     DPTR,#nb
   \   00004D   F0           MOVX    @DPTR,A
    212              macTxBe = (pMacDataTx->internal.txOptions & MAC_TXOPTION_ALT_BE) ? macPib.altBe : macPib.minBe;
   \   00004E   90....       MOV     DPTR,#pMacDataTx
   \   000051   E0           MOVX    A,@DPTR
   \   000052   240E         ADD     A,#0xe
   \   000054   F8           MOV     R0,A
   \   000055   A3           INC     DPTR
   \   000056   E0           MOVX    A,@DPTR
   \   000057   3400         ADDC    A,#0x0
   \   000059   F9           MOV     R1,A
   \   00005A   8882         MOV     DPL,R0
   \   00005C   8983         MOV     DPH,R1
   \   00005E   E0           MOVX    A,@DPTR
   \   00005F   A2E6         MOV     C,0xE0 /* A   */.6
   \   000061   5007         JNC     ??macTxFrame_6
   \   000063   90....       MOV     DPTR,#(macPib + 58)
   \   000066   E0           MOVX    A,@DPTR
   \   000067   FA           MOV     R2,A
   \   000068   8005         SJMP    ??macTxFrame_7
   \                     ??macTxFrame_6:
   \   00006A   90....       MOV     DPTR,#(macPib + 28)
   \   00006D   E0           MOVX    A,@DPTR
   \   00006E   FA           MOV     R2,A
   \                     ??macTxFrame_7:
   \   00006F   EA           MOV     A,R2
   \   000070   90....       MOV     DPTR,#macTxBe
   \   000073   F0           MOVX    @DPTR,A
    213          
    214              if ((macTxType == MAC_TX_TYPE_SLOTTED_CSMA) && (macPib.battLifeExt))
   \   000074   90....       MOV     DPTR,#macTxType
   \   000077   E0           MOVX    A,@DPTR
   \   000078   701D         JNZ     ??macTxFrame_8
   \   00007A   90....       MOV     DPTR,#(macPib + 3)
   \   00007D   E0           MOVX    A,@DPTR
   \   00007E   6017         JZ      ??macTxFrame_8
    215              {
    216                macTxBe = MIN(2, macTxBe);
   \   000080   90....       MOV     DPTR,#macTxBe
   \   000083   E0           MOVX    A,@DPTR
   \   000084   C3           CLR     C
   \   000085   9403         SUBB    A,#0x3
   \   000087   4004         JC      ??macTxFrame_9
   \   000089   7A02         MOV     R2,#0x2
   \   00008B   8005         SJMP    ??macTxFrame_10
   \                     ??macTxFrame_9:
   \   00008D   90....       MOV     DPTR,#macTxBe
   \   000090   E0           MOVX    A,@DPTR
   \   000091   FA           MOV     R2,A
   \                     ??macTxFrame_10:
   \   000092   EA           MOV     A,R2
   \   000093   90....       MOV     DPTR,#macTxBe
   \   000096   F0           MOVX    @DPTR,A
    217              }
    218          
    219              txCsmaPrep();
   \                     ??macTxFrame_8:
   \   000097                ; Setup parameters for call to function txCsmaPrep
   \   000097   12....       LCALL   ??txCsmaPrep?relay
    220            }
    221          
    222            /*-------------------------------------------------------------------------------
    223             *  Load transmit FIFO unless this is a retransmit.  No need to write
    224             *  the FIFO again in that case.
    225             */
    226            if (!txRetransmitFlag)
   \                     ??macTxFrame_4:
   \   00009A   90....       MOV     DPTR,#txRetransmitFlag
   \   00009D   E0           MOVX    A,@DPTR
   \   00009E   6003         JZ      $+5
   \   0000A0   02....       LJMP    ??macTxFrame_11 & 0xFFFF
    227            {
    228              uint8 * p;
    229              uint8   lenMhrMsdu;
    230          
    231              MAC_ASSERT(pMacDataTx != NULL); /* must have data to transmit */
   \   0000A3   90....       MOV     DPTR,#pMacDataTx
   \   0000A6   E0           MOVX    A,@DPTR
   \   0000A7   6400         XRL     A,#0x0
   \   0000A9   7004         JNZ     ??macTxFrame_12
   \   0000AB   A3           INC     DPTR
   \   0000AC   E0           MOVX    A,@DPTR
   \   0000AD   6400         XRL     A,#0x0
   \                     ??macTxFrame_12:
   \   0000AF   7003         JNZ     ??macTxFrame_13
   \   0000B1                ; Setup parameters for call to function halAssertHandler
   \   0000B1   12....       LCALL   ??halAssertHandler?relay
    232          
    233              /* save needed parameters */
    234              txAckReq = MAC_ACK_REQUEST(pMacDataTx->msdu.p);
   \                     ??macTxFrame_13:
   \   0000B4   90....       MOV     DPTR,#pMacDataTx
   \   0000B7   E0           MOVX    A,@DPTR
   \   0000B8   F8           MOV     R0,A
   \   0000B9   A3           INC     DPTR
   \   0000BA   E0           MOVX    A,@DPTR
   \   0000BB   F583         MOV     DPH,A
   \   0000BD   8882         MOV     DPL,R0
   \   0000BF   A3           INC     DPTR
   \   0000C0   A3           INC     DPTR
   \   0000C1   E0           MOVX    A,@DPTR
   \   0000C2   F8           MOV     R0,A
   \   0000C3   A3           INC     DPTR
   \   0000C4   E0           MOVX    A,@DPTR
   \   0000C5   F583         MOV     DPH,A
   \   0000C7   8882         MOV     DPL,R0
   \   0000C9   E0           MOVX    A,@DPTR
   \   0000CA   5420         ANL     A,#0x20
   \   0000CC   90....       MOV     DPTR,#txAckReq
   \   0000CF   F0           MOVX    @DPTR,A
    235              txSeqn   = MAC_SEQ_NUMBER(pMacDataTx->msdu.p);
   \   0000D0   90....       MOV     DPTR,#pMacDataTx
   \   0000D3   E0           MOVX    A,@DPTR
   \   0000D4   F8           MOV     R0,A
   \   0000D5   A3           INC     DPTR
   \   0000D6   E0           MOVX    A,@DPTR
   \   0000D7   F583         MOV     DPH,A
   \   0000D9   8882         MOV     DPL,R0
   \   0000DB   A3           INC     DPTR
   \   0000DC   A3           INC     DPTR
   \   0000DD   E0           MOVX    A,@DPTR
   \   0000DE   F8           MOV     R0,A
   \   0000DF   A3           INC     DPTR
   \   0000E0   E0           MOVX    A,@DPTR
   \   0000E1   F583         MOV     DPH,A
   \   0000E3   8882         MOV     DPL,R0
   \   0000E5   A3           INC     DPTR
   \   0000E6   A3           INC     DPTR
   \   0000E7   E0           MOVX    A,@DPTR
   \   0000E8   90....       MOV     DPTR,#txSeqn
   \   0000EB   F0           MOVX    @DPTR,A
    236          
    237              /* set length of frame (note: use of term msdu is a misnomer, here it's actually mhr + msdu) */
    238              lenMhrMsdu = pMacDataTx->msdu.len;
   \   0000EC   90....       MOV     DPTR,#pMacDataTx
   \   0000EF   E0           MOVX    A,@DPTR
   \   0000F0   F8           MOV     R0,A
   \   0000F1   A3           INC     DPTR
   \   0000F2   E0           MOVX    A,@DPTR
   \   0000F3   F583         MOV     DPH,A
   \   0000F5   8882         MOV     DPL,R0
   \   0000F7   A3           INC     DPTR
   \   0000F8   A3           INC     DPTR
   \   0000F9   A3           INC     DPTR
   \   0000FA   A3           INC     DPTR
   \   0000FB   E0           MOVX    A,@DPTR
   \   0000FC   F5..         MOV     ?V0 + 1,A
    239          
    240              /* calling code guarantees an unused prepended byte  */
    241              p = pMacDataTx->msdu.p - PREPENDED_BYTE_LEN;
   \   0000FE   90....       MOV     DPTR,#pMacDataTx
   \   000101   E0           MOVX    A,@DPTR
   \   000102   F8           MOV     R0,A
   \   000103   A3           INC     DPTR
   \   000104   E0           MOVX    A,@DPTR
   \   000105   F583         MOV     DPH,A
   \   000107   8882         MOV     DPL,R0
   \   000109   A3           INC     DPTR
   \   00010A   A3           INC     DPTR
   \   00010B   E0           MOVX    A,@DPTR
   \   00010C   24FF         ADD     A,#-0x1
   \   00010E   F8           MOV     R0,A
   \   00010F   A3           INC     DPTR
   \   000110   E0           MOVX    A,@DPTR
   \   000111   34FF         ADDC    A,#-0x1
   \   000113   F9           MOV     R1,A
   \   000114   E8           MOV     A,R0
   \   000115   FE           MOV     R6,A
   \   000116   E9           MOV     A,R1
   \   000117   FF           MOV     R7,A
    242          
    243              /* first byte of buffer is length of MPDU */
    244              *p = lenMhrMsdu + MFR_LEN;
   \   000118   7402         MOV     A,#0x2
   \   00011A   25..         ADD     A,?V0 + 1
   \   00011C   8E82         MOV     DPL,R6
   \   00011E   8F83         MOV     DPH,R7
   \   000120   F0           MOVX    @DPTR,A
    245          
    246              /*
    247               *  Flush the TX FIFO.  This is necessary in case the previous transmit was never
    248               *  actually sent (e.g. CSMA failed without strobing TXON).  If bytes are written to
    249               *  the FIFO but not transmitted, they remain in the FIFO to be transmitted whenever
    250               *  a strobe of TXON does happen.
    251               */
    252              MAC_RADIO_FLUSH_TX_FIFO();
   \   000121   75E1E7       MOV     0xe1,#-0x19
    253          
    254              /* write bytes to FIFO, prepended byte is included, MFR is not (it's generated by hardware) */
    255              MAC_RADIO_WRITE_TX_FIFO(p, PREPENDED_BYTE_LEN + lenMhrMsdu);
   \   000124                ; Setup parameters for call to function macMemWriteTxFifo
   \   000124   7401         MOV     A,#0x1
   \   000126   25..         ADD     A,?V0 + 1
   \   000128   F9           MOV     R1,A
   \   000129   EE           MOV     A,R6
   \   00012A   FA           MOV     R2,A
   \   00012B   EF           MOV     A,R7
   \   00012C   FB           MOV     R3,A
   \   00012D   12....       LCALL   ??macMemWriteTxFifo?relay
    256            }
    257          
    258            /*-------------------------------------------------------------------------------
    259             *  If not receiving, start the transmit.  If receive is active
    260             *  queue up the transmit.
    261             *
    262             *  Critical sections around the state change prevents any sort of race condition
    263             *  with  macTxStartQueuedFrame().  This guarantees function txGo() will only be
    264             *  called once.
    265             */
    266            {
    267              halIntState_t  s;
    268          
    269              HAL_ENTER_CRITICAL_SECTION(s);
   \                     ??macTxFrame_11:
   \   000130   A2AF         MOV     C,0xa8.7
   \   000132   E4           CLR     A
   \   000133   92E0         MOV     0xE0 /* A   */.0,C
   \   000135   FE           MOV     R6,A
   \   000136   C2AF         CLR     0xa8.7
    270              if (!macRxActive && !macRxOutgoingAckFlag)
   \   000138   90....       MOV     DPTR,#macRxActive
   \   00013B   E0           MOVX    A,@DPTR
   \   00013C   7016         JNZ     ??macTxFrame_14
   \   00013E   90....       MOV     DPTR,#macRxOutgoingAckFlag
   \   000141   E0           MOVX    A,@DPTR
   \   000142   7010         JNZ     ??macTxFrame_14
    271              {
    272                macTxActive = MAC_TX_ACTIVE_GO;
   \   000144   7483         MOV     A,#-0x7d
   \   000146   90....       MOV     DPTR,#macTxActive
   \   000149   F0           MOVX    @DPTR,A
    273                HAL_EXIT_CRITICAL_SECTION(s);
   \   00014A   EE           MOV     A,R6
   \   00014B   A2E0         MOV     C,0xE0 /* A   */.0
   \   00014D   92AF         MOV     0xa8.7,C
    274                txGo();
   \   00014F                ; Setup parameters for call to function txGo
   \   00014F   12....       LCALL   ??txGo?relay
   \   000152   800B         SJMP    ??macTxFrame_2
    275              }
    276              else
    277              {
    278                macTxActive = MAC_TX_ACTIVE_QUEUED;
   \                     ??macTxFrame_14:
   \   000154   7402         MOV     A,#0x2
   \   000156   90....       MOV     DPTR,#macTxActive
   \   000159   F0           MOVX    @DPTR,A
    279                HAL_EXIT_CRITICAL_SECTION(s);
   \   00015A   EE           MOV     A,R6
   \   00015B   A2E0         MOV     C,0xE0 /* A   */.0
   \   00015D   92AF         MOV     0xa8.7,C
   \                     ??macTxFrame_2:
   \   00015F   7F02         MOV     R7,#0x2
   \   000161   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000164                REQUIRE _A_IEN0
   \   000164                REQUIRE RFST
    280              }
    281            }
    282          }
    283          
    284          
    285          /*=================================================================================================
    286           * @fn          txCsmaPrep
    287           *
    288           * @brief       Prepare/initialize for a CSMA transmit.
    289           *
    290           * @param       none
    291           *
    292           * @return      none
    293           *=================================================================================================
    294           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    295          static void txCsmaPrep(void)
   \                     txCsmaPrep:
    296          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    297            macTxCsmaBackoffDelay = macRadioRandomByte() & ((1 << macTxBe) - 1);
   \   000005                ; Setup parameters for call to function macRadioRandomByte
   \   000005   12....       LCALL   ??macRadioRandomByte?relay
   \   000008   E9           MOV     A,R1
   \   000009   FA           MOV     R2,A
   \   00000A   75..01       MOV     ?V0 + 0,#0x1
   \   00000D   75..00       MOV     ?V0 + 1,#0x0
   \   000010   90....       MOV     DPTR,#macTxBe
   \   000013   E0           MOVX    A,@DPTR
   \   000014   78..         MOV     R0,#?V0 + 0
   \   000016   12....       LCALL   ?S_SHL
   \   000019   E5..         MOV     A,?V0 + 0
   \   00001B   24FF         ADD     A,#-0x1
   \   00001D   5A           ANL     A,R2
   \   00001E   90....       MOV     DPTR,#macTxCsmaBackoffDelay
   \   000021   F0           MOVX    @DPTR,A
    298          
    299            if (macTxType == MAC_TX_TYPE_SLOTTED_CSMA)
   \   000022   90....       MOV     DPTR,#macTxType
   \   000025   E0           MOVX    A,@DPTR
   \   000026   7005         JNZ     ??txCsmaPrep_0
    300            {
    301              MAC_RADIO_TX_PREP_CSMA_SLOTTED();
   \   000028                ; Setup parameters for call to function macCspTxPrepCsmaSlotted
   \   000028   12....       LCALL   ??macCspTxPrepCsmaSlotted?relay
   \   00002B   8003         SJMP    ??txCsmaPrep_1
    302            }
    303            else
    304            {
    305              MAC_RADIO_TX_PREP_CSMA_UNSLOTTED();
   \                     ??txCsmaPrep_0:
   \   00002D                ; Setup parameters for call to function macCspTxPrepCsmaUnslotted
   \   00002D   12....       LCALL   ??macCspTxPrepCsmaUnslotted?relay
    306            }
    307          }
   \                     ??txCsmaPrep_1:
   \   000030   7F02         MOV     R7,#0x2
   \   000032   02....       LJMP    ?BANKED_LEAVE_XDATA
    308          
    309          
    310          /*=================================================================================================
    311           * @fn          txGo
    312           *
    313           * @brief       Start a transmit going.
    314           *
    315           * @param       none
    316           *
    317           * @return      none
    318           *=================================================================================================
    319           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    320          static void txGo(void)
   \                     txGo:
    321          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    322            /*
    323             *  If execution has reached this point, any transmitted ACK has long since completed.  It is
    324             *  possible though that there is still a pending callback.  If so, it is irrelevant and needs to
    325             *  be canceled at this point.
    326             */
    327            MAC_RADIO_CANCEL_ACK_TX_DONE_CALLBACK();
   \   000004   5391BF       ANL     0x91,#0xbf
    328            macRxOutgoingAckFlag = 0;
   \   000007   7400         MOV     A,#0x0
   \   000009   90....       MOV     DPTR,#macRxOutgoingAckFlag
   \   00000C   F0           MOVX    @DPTR,A
    329          
    330            /* based on type of transmit, call the correct "go" functionality */
    331            if (macTxType == MAC_TX_TYPE_SLOTTED)
   \   00000D   90....       MOV     DPTR,#macTxType
   \   000010   E0           MOVX    A,@DPTR
   \   000011   6402         XRL     A,#0x2
   \   000013   7005         JNZ     ??txGo_0
    332            {
    333              MAC_RADIO_TX_GO_SLOTTED();
   \   000015                ; Setup parameters for call to function macCspTxGoSlotted
   \   000015   12....       LCALL   ??macCspTxGoSlotted?relay
   \   000018   8003         SJMP    ??txGo_1
    334            }
    335            else
    336            {
    337              txCsmaGo();
   \                     ??txGo_0:
   \   00001A                ; Setup parameters for call to function txCsmaGo
   \   00001A   12....       LCALL   ??txCsmaGo?relay
    338            }
    339          }
   \                     ??txGo_1:
   \   00001D   D083         POP     DPH
   \   00001F   D082         POP     DPL
   \   000021   02....       LJMP    ?BRET
   \   000024                REQUIRE RFIM
    340          
    341          
    342          /*=================================================================================================
    343           * @fn          txCsmaGo
    344           *
    345           * @brief       Start a CSMA transmit going.
    346           *
    347           * @param       none
    348           *
    349           * @return      none
    350           *=================================================================================================
    351           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    352          static void txCsmaGo(void)
   \                     txCsmaGo:
    353          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    354            if (macTxType == MAC_TX_TYPE_SLOTTED_CSMA)
   \   000004   90....       MOV     DPTR,#macTxType
   \   000007   E0           MOVX    A,@DPTR
   \   000008   7014         JNZ     ??txCsmaGo_0
    355            {
    356              if (macTxCsmaBackoffDelay >= macDataTxTimeAvailable())
   \   00000A                ; Setup parameters for call to function macDataTxTimeAvailable
   \   00000A   12....       LCALL   ??macDataTxTimeAvailable?relay
   \   00000D   E9           MOV     A,R1
   \   00000E   FA           MOV     R2,A
   \   00000F   90....       MOV     DPTR,#macTxCsmaBackoffDelay
   \   000012   E0           MOVX    A,@DPTR
   \   000013   C3           CLR     C
   \   000014   9A           SUBB    A,R2
   \   000015   4007         JC      ??txCsmaGo_0
    357              {
    358                txComplete(MAC_NO_TIME);
   \   000017                ; Setup parameters for call to function txComplete
   \   000017   791C         MOV     R1,#0x1c
   \   000019   12....       LCALL   ??txComplete?relay
    359                return;
   \   00001C   8003         SJMP    ??txCsmaGo_1
    360              }
    361            }
    362          
    363            MAC_RADIO_TX_GO_CSMA();
   \                     ??txCsmaGo_0:
   \   00001E                ; Setup parameters for call to function macCspTxGoCsma
   \   00001E   12....       LCALL   ??macCspTxGoCsma?relay
    364          }
   \                     ??txCsmaGo_1:
   \   000021   D083         POP     DPH
   \   000023   D082         POP     DPL
   \   000025   02....       LJMP    ?BRET
    365          
    366          
    367          /**************************************************************************************************
    368           * @fn          macTxFrameRetransmit
    369           *
    370           * @brief       Retransmit the last frame.
    371           *
    372           * @param       none
    373           *
    374           * @return      none
    375           **************************************************************************************************
    376           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    377          void macTxFrameRetransmit(void)
   \                     macTxFrameRetransmit:
    378          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    379            txRetransmitFlag = 1;
   \   000004   7401         MOV     A,#0x1
   \   000006   90....       MOV     DPTR,#txRetransmitFlag
   \   000009   F0           MOVX    @DPTR,A
    380            macTxFrame(macTxType);
   \   00000A                ; Setup parameters for call to function macTxFrame
   \   00000A   90....       MOV     DPTR,#macTxType
   \   00000D   E0           MOVX    A,@DPTR
   \   00000E   F9           MOV     R1,A
   \   00000F   12....       LCALL   ??macTxFrame?relay
    381          }
   \   000012   D083         POP     DPH
   \   000014   D082         POP     DPL
   \   000016   02....       LJMP    ?BRET
    382          
    383          
    384          /**************************************************************************************************
    385           * @fn          macTxStartQueuedFrame
    386           *
    387           * @brief       See if there is a queued frame waiting to transmit.  If so, initiate
    388           *              the transmit now.
    389           *
    390           * @param       none
    391           *
    392           * @return      none
    393           **************************************************************************************************
    394           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    395          void macTxStartQueuedFrame(void)
   \                     macTxStartQueuedFrame:
    396          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    397            halIntState_t  s;
    398          
    399            MAC_ASSERT(!macRxActive && !macRxOutgoingAckFlag); /* queued frames should not transmit in middle of a receive */
   \   000005   90....       MOV     DPTR,#macRxActive
   \   000008   E0           MOVX    A,@DPTR
   \   000009   7006         JNZ     ??macTxStartQueuedFrame_0
   \   00000B   90....       MOV     DPTR,#macRxOutgoingAckFlag
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   6003         JZ      ??macTxStartQueuedFrame_1
   \                     ??macTxStartQueuedFrame_0:
   \   000011                ; Setup parameters for call to function halAssertHandler
   \   000011   12....       LCALL   ??halAssertHandler?relay
    400            
    401            /*
    402             *  Critical sections around the state change prevents any sort of race condition
    403             *  with macTxFrame().  This guarantees function txGo() will only be be called once.
    404             */
    405            HAL_ENTER_CRITICAL_SECTION(s);
   \                     ??macTxStartQueuedFrame_1:
   \   000014   A2AF         MOV     C,0xa8.7
   \   000016   E4           CLR     A
   \   000017   92E0         MOV     0xE0 /* A   */.0,C
   \   000019   FE           MOV     R6,A
   \   00001A   C2AF         CLR     0xa8.7
    406            if (macTxActive == MAC_TX_ACTIVE_QUEUED)
   \   00001C   90....       MOV     DPTR,#macTxActive
   \   00001F   E0           MOVX    A,@DPTR
   \   000020   6402         XRL     A,#0x2
   \   000022   7010         JNZ     ??macTxStartQueuedFrame_2
    407            {
    408              macTxActive = MAC_TX_ACTIVE_GO;
   \   000024   7483         MOV     A,#-0x7d
   \   000026   90....       MOV     DPTR,#macTxActive
   \   000029   F0           MOVX    @DPTR,A
    409              HAL_EXIT_CRITICAL_SECTION(s);
   \   00002A   EE           MOV     A,R6
   \   00002B   A2E0         MOV     C,0xE0 /* A   */.0
   \   00002D   92AF         MOV     0xa8.7,C
    410              txGo();
   \   00002F                ; Setup parameters for call to function txGo
   \   00002F   12....       LCALL   ??txGo?relay
   \   000032   8005         SJMP    ??macTxStartQueuedFrame_3
    411            }
    412            else
    413            {
    414              HAL_EXIT_CRITICAL_SECTION(s);
   \                     ??macTxStartQueuedFrame_2:
   \   000034   EE           MOV     A,R6
   \   000035   A2E0         MOV     C,0xE0 /* A   */.0
   \   000037   92AF         MOV     0xa8.7,C
    415            }
    416          }
   \                     ??macTxStartQueuedFrame_3:
   \   000039   7F01         MOV     R7,#0x1
   \   00003B   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   00003E                REQUIRE _A_IEN0
    417          
    418          
    419          /**************************************************************************************************
    420           * @fn          macTxChannelBusyCallback
    421           *
    422           * @brief       This callback is executed if a CSMA transmit was attempted but the channel
    423           *              was busy.
    424           *
    425           * @param       none
    426           *
    427           * @return      none
    428           **************************************************************************************************
    429           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    430          void macTxChannelBusyCallback(void)
   \                     macTxChannelBusyCallback:
    431          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    432            MAC_ASSERT((macTxType == MAC_TX_TYPE_SLOTTED_CSMA) || (macTxType == MAC_TX_TYPE_UNSLOTTED_CSMA));
   \   000004   90....       MOV     DPTR,#macTxType
   \   000007   E0           MOVX    A,@DPTR
   \   000008   600B         JZ      ??macTxChannelBusyCallback_0
   \   00000A   90....       MOV     DPTR,#macTxType
   \   00000D   E0           MOVX    A,@DPTR
   \   00000E   6401         XRL     A,#0x1
   \   000010   6003         JZ      ??macTxChannelBusyCallback_0
   \   000012                ; Setup parameters for call to function halAssertHandler
   \   000012   12....       LCALL   ??halAssertHandler?relay
    433          
    434            /* turn off receiver if allowed */
    435            macTxActive = MAC_TX_ACTIVE_CHANNEL_BUSY;
   \                     ??macTxChannelBusyCallback_0:
   \   000015   7404         MOV     A,#0x4
   \   000017   90....       MOV     DPTR,#macTxActive
   \   00001A   F0           MOVX    @DPTR,A
    436            macRxOffRequest();
   \   00001B                ; Setup parameters for call to function macRxOffRequest
   \   00001B   12....       LCALL   ??macRxOffRequest?relay
    437          
    438            /*  clear channel assement failed, follow through with CSMA algorithm */
    439            nb++;
   \   00001E   90....       MOV     DPTR,#nb
   \   000021   E0           MOVX    A,@DPTR
   \   000022   2401         ADD     A,#0x1
   \   000024   F0           MOVX    @DPTR,A
    440            if (nb > macPib.maxCsmaBackoffs)
   \   000025   90....       MOV     DPTR,#(macPib + 27)
   \   000028   E0           MOVX    A,@DPTR
   \   000029   C0E0         PUSH    A
   \   00002B   90....       MOV     DPTR,#nb
   \   00002E   E0           MOVX    A,@DPTR
   \   00002F   FA           MOV     R2,A
   \   000030   D0E0         POP     A
   \   000032   C3           CLR     C
   \   000033   9A           SUBB    A,R2
   \   000034   5007         JNC     ??macTxChannelBusyCallback_1
    441            {
    442              txComplete(MAC_CHANNEL_ACCESS_FAILURE);
   \   000036                ; Setup parameters for call to function txComplete
   \   000036   79E1         MOV     R1,#-0x1f
   \   000038   12....       LCALL   ??txComplete?relay
   \   00003B   8041         SJMP    ??macTxChannelBusyCallback_2
    443            }
    444            else
    445            {
    446              macTxBe = MIN(macTxBe+1, macPib.maxBe);
   \                     ??macTxChannelBusyCallback_1:
   \   00003D   90....       MOV     DPTR,#macTxBe
   \   000040   E0           MOVX    A,@DPTR
   \   000041   F8           MOV     R0,A
   \   000042   7900         MOV     R1,#0x0
   \   000044   7401         MOV     A,#0x1
   \   000046   28           ADD     A,R0
   \   000047   F8           MOV     R0,A
   \   000048   7400         MOV     A,#0x0
   \   00004A   39           ADDC    A,R1
   \   00004B   F9           MOV     R1,A
   \   00004C   90....       MOV     DPTR,#(macPib + 39)
   \   00004F   E0           MOVX    A,@DPTR
   \   000050   FA           MOV     R2,A
   \   000051   7B00         MOV     R3,#0x0
   \   000053   C3           CLR     C
   \   000054   E8           MOV     A,R0
   \   000055   9A           SUBB    A,R2
   \   000056   E9           MOV     A,R1
   \   000057   9B           SUBB    A,R3
   \   000058   A2D2         MOV     C,0xD0 /* PSW */.2
   \   00005A   65D0         XRL     A,PSW
   \   00005C   33           RLC     A
   \   00005D   5009         JNC     ??macTxChannelBusyCallback_3
   \   00005F   90....       MOV     DPTR,#macTxBe
   \   000062   E0           MOVX    A,@DPTR
   \   000063   2401         ADD     A,#0x1
   \   000065   FA           MOV     R2,A
   \   000066   8005         SJMP    ??macTxChannelBusyCallback_4
   \                     ??macTxChannelBusyCallback_3:
   \   000068   90....       MOV     DPTR,#(macPib + 39)
   \   00006B   E0           MOVX    A,@DPTR
   \   00006C   FA           MOV     R2,A
   \                     ??macTxChannelBusyCallback_4:
   \   00006D   EA           MOV     A,R2
   \   00006E   90....       MOV     DPTR,#macTxBe
   \   000071   F0           MOVX    @DPTR,A
    447              txCsmaPrep();
   \   000072                ; Setup parameters for call to function txCsmaPrep
   \   000072   12....       LCALL   ??txCsmaPrep?relay
    448              macTxActive = MAC_TX_ACTIVE_GO;
   \   000075   7483         MOV     A,#-0x7d
   \   000077   90....       MOV     DPTR,#macTxActive
   \   00007A   F0           MOVX    @DPTR,A
    449              txCsmaGo();
   \   00007B                ; Setup parameters for call to function txCsmaGo
   \   00007B   12....       LCALL   ??txCsmaGo?relay
    450            }
    451          }
   \                     ??macTxChannelBusyCallback_2:
   \   00007E   D083         POP     DPH
   \   000080   D082         POP     DPL
   \   000082   02....       LJMP    ?BRET
    452          
    453          
    454          /**************************************************************************************************
    455           * @fn          macTxDoneCallback
    456           *
    457           * @brief       This callback is executed when transmit completes.
    458           *
    459           * @param       none
    460           *
    461           * @return      none
    462           **************************************************************************************************
    463           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    464          void macTxDoneCallback(void)
   \                     macTxDoneCallback:
    465          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    466            halIntState_t  s;
    467          
    468            /*
    469             *  There is a small chance this function could be called twice for a single transmit.
    470             *  To prevent logic from executing twice, the state variable macTxActive is used as
    471             *  a gating mechanism to guarantee single time execution.
    472             */
    473            HAL_ENTER_CRITICAL_SECTION(s);
   \   000005   A2AF         MOV     C,0xa8.7
   \   000007   E4           CLR     A
   \   000008   92E0         MOV     0xE0 /* A   */.0,C
   \   00000A   FE           MOV     R6,A
   \   00000B   C2AF         CLR     0xa8.7
    474            if (macTxActive == MAC_TX_ACTIVE_GO)
   \   00000D   90....       MOV     DPTR,#macTxActive
   \   000010   E0           MOVX    A,@DPTR
   \   000011   6483         XRL     A,#0x83
   \   000013   7028         JNZ     ??macTxDoneCallback_0
    475            {
    476              /* see if ACK was requested */
    477              if (!txAckReq)
   \   000015   90....       MOV     DPTR,#txAckReq
   \   000018   E0           MOVX    A,@DPTR
   \   000019   7012         JNZ     ??macTxDoneCallback_1
    478              {
    479                macTxActive = MAC_TX_ACTIVE_DONE;
   \   00001B   7485         MOV     A,#-0x7b
   \   00001D   90....       MOV     DPTR,#macTxActive
   \   000020   F0           MOVX    @DPTR,A
    480                HAL_EXIT_CRITICAL_SECTION(s);
   \   000021   EE           MOV     A,R6
   \   000022   A2E0         MOV     C,0xE0 /* A   */.0
   \   000024   92AF         MOV     0xa8.7,C
    481          
    482                /* ACK was not requested, transmit is complete */
    483                txComplete(MAC_SUCCESS);
   \   000026                ; Setup parameters for call to function txComplete
   \   000026   7900         MOV     R1,#0x0
   \   000028   12....       LCALL   ??txComplete?relay
   \   00002B   8015         SJMP    ??macTxDoneCallback_2
    484              }
    485              else
    486              {
    487                /*
    488                 *  ACK was requested - must wait to receive it.  A timer is set
    489                 *  to expire after the timeout duration for waiting for an ACK.
    490                 *  If an ACK is received, the function macTxAckReceived() is called.
    491                 *  If an ACK is not received within the timeout period,
    492                 *  the function macTxAckTimeoutCallback() is called.
    493                 */
    494                macTxActive = MAC_TX_ACTIVE_LISTEN_FOR_ACK;
   \                     ??macTxDoneCallback_1:
   \   00002D   7486         MOV     A,#-0x7a
   \   00002F   90....       MOV     DPTR,#macTxActive
   \   000032   F0           MOVX    @DPTR,A
    495                MAC_RADIO_TX_REQUEST_ACK_TIMEOUT_CALLBACK();
   \   000033                ; Setup parameters for call to function macCspTxRequestAckTimeoutCallback
   \   000033   12....       LCALL   ??macCspTxRequestAckTimeoutCallback?relay
    496                HAL_EXIT_CRITICAL_SECTION(s);
   \   000036   EE           MOV     A,R6
   \   000037   A2E0         MOV     C,0xE0 /* A   */.0
   \   000039   92AF         MOV     0xa8.7,C
   \   00003B   8005         SJMP    ??macTxDoneCallback_2
    497              }
    498            }
    499            else
    500            {
    501              HAL_EXIT_CRITICAL_SECTION(s);
   \                     ??macTxDoneCallback_0:
   \   00003D   EE           MOV     A,R6
   \   00003E   A2E0         MOV     C,0xE0 /* A   */.0
   \   000040   92AF         MOV     0xa8.7,C
    502            }
    503          }
   \                     ??macTxDoneCallback_2:
   \   000042   7F01         MOV     R7,#0x1
   \   000044   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000047                REQUIRE _A_IEN0
    504          
    505          
    506          /**************************************************************************************************
    507           * @fn          macTxAckReceivedCallback
    508           *
    509           * @brief       This function is called by the receive logic when an ACK is received and
    510           *              transmit logic is listening for an ACK.
    511           *
    512           * @param       seqn        - sequence number of received ACK
    513           * @param       pendingFlag - set if pending flag of ACK is set, cleared otherwise
    514           *
    515           * @return      none
    516           **************************************************************************************************
    517           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    518          void macTxAckReceivedCallback(uint8 seqn, uint8 pendingFlag)
   \                     macTxAckReceivedCallback:
    519          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
   \   000007   EA           MOV     A,R2
   \   000008   FF           MOV     R7,A
    520            halIntState_t  s;
    521          
    522            /* only process if listening for an ACK; critical section prevents race condition problems */
    523            HAL_ENTER_CRITICAL_SECTION(s);
   \   000009   A2AF         MOV     C,0xa8.7
   \   00000B   E4           CLR     A
   \   00000C   92E0         MOV     0xE0 /* A   */.0,C
   \   00000E   F5..         MOV     ?V0 + 0,A
   \   000010   C2AF         CLR     0xa8.7
    524            if (macTxActive == MAC_TX_ACTIVE_LISTEN_FOR_ACK)
   \   000012   90....       MOV     DPTR,#macTxActive
   \   000015   E0           MOVX    A,@DPTR
   \   000016   6486         XRL     A,#0x86
   \   000018   702E         JNZ     ??macTxAckReceivedCallback_0
    525            {
    526              macTxActive = MAC_TX_ACTIVE_POST_ACK;
   \   00001A   7487         MOV     A,#-0x79
   \   00001C   90....       MOV     DPTR,#macTxActive
   \   00001F   F0           MOVX    @DPTR,A
    527              MAC_RADIO_TX_CANCEL_ACK_TIMEOUT_CALLBACK();
   \   000020                ; Setup parameters for call to function macCspTxCancelAckTimeoutCallback
   \   000020   12....       LCALL   ??macCspTxCancelAckTimeoutCallback?relay
    528              HAL_EXIT_CRITICAL_SECTION(s);
   \   000023   E5..         MOV     A,?V0 + 0
   \   000025   A2E0         MOV     C,0xE0 /* A   */.0
   \   000027   92AF         MOV     0xa8.7,C
    529          
    530              /* see if the sequence number of received ACK matches sequence number of packet just sent */
    531              if (seqn == txSeqn)
   \   000029   90....       MOV     DPTR,#txSeqn
   \   00002C   E0           MOVX    A,@DPTR
   \   00002D   6E           XRL     A,R6
   \   00002E   7011         JNZ     ??macTxAckReceivedCallback_1
    532              {
    533                /*
    534                 *  Sequence numbers match so transmit is successful.  Return appropriate
    535                 *  status based on the pending flag of the received ACK.
    536                 */
    537                if (pendingFlag)
   \   000030   EF           MOV     A,R7
   \   000031   6007         JZ      ??macTxAckReceivedCallback_2
    538                {
    539                  txComplete(MAC_ACK_PENDING);
   \   000033                ; Setup parameters for call to function txComplete
   \   000033   791B         MOV     R1,#0x1b
   \   000035   12....       LCALL   ??txComplete?relay
   \   000038   8014         SJMP    ??macTxAckReceivedCallback_3
    540                }
    541                else
    542                {
    543                  txComplete(MAC_SUCCESS);
   \                     ??macTxAckReceivedCallback_2:
   \   00003A                ; Setup parameters for call to function txComplete
   \   00003A   7900         MOV     R1,#0x0
   \   00003C   12....       LCALL   ??txComplete?relay
   \   00003F   800D         SJMP    ??macTxAckReceivedCallback_3
    544                }
    545              }
    546              else
    547              {
    548                /* sequence number did not match; per spec, transmit failed at this point */
    549                txComplete(MAC_NO_ACK);
   \                     ??macTxAckReceivedCallback_1:
   \   000041                ; Setup parameters for call to function txComplete
   \   000041   79E9         MOV     R1,#-0x17
   \   000043   12....       LCALL   ??txComplete?relay
   \   000046   8006         SJMP    ??macTxAckReceivedCallback_3
    550              }
    551            }
    552            else
    553            {
    554              HAL_EXIT_CRITICAL_SECTION(s);
   \                     ??macTxAckReceivedCallback_0:
   \   000048   E5..         MOV     A,?V0 + 0
   \   00004A   A2E0         MOV     C,0xE0 /* A   */.0
   \   00004C   92AF         MOV     0xa8.7,C
    555            }
    556          }
   \                     ??macTxAckReceivedCallback_3:
   \   00004E   7F01         MOV     R7,#0x1
   \   000050   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000053                REQUIRE _A_IEN0
    557          
    558          
    559          /**************************************************************************************************
    560           * @fn          macTxAckNotReceivedCallback
    561           *
    562           * @brief       This function is called by the receive logic when transmit is listening
    563           *              for an ACK but something else is received.  It is also called if the
    564           *              listen-for-ACK timeout is reached.
    565           *
    566           * @param       none
    567           *
    568           * @return      none
    569           **************************************************************************************************
    570           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    571          void macTxAckNotReceivedCallback(void)
   \                     macTxAckNotReceivedCallback:
    572          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    573            halIntState_t  s;
    574          
    575            /* only process if listening for an ACK; critical section prevents race condition problems */
    576            HAL_ENTER_CRITICAL_SECTION(s);
   \   000005   A2AF         MOV     C,0xa8.7
   \   000007   E4           CLR     A
   \   000008   92E0         MOV     0xE0 /* A   */.0,C
   \   00000A   FE           MOV     R6,A
   \   00000B   C2AF         CLR     0xa8.7
    577            if (macTxActive == MAC_TX_ACTIVE_LISTEN_FOR_ACK)
   \   00000D   90....       MOV     DPTR,#macTxActive
   \   000010   E0           MOVX    A,@DPTR
   \   000011   6486         XRL     A,#0x86
   \   000013   7015         JNZ     ??macTxAckNotReceivedCallback_0
    578            {
    579              macTxActive = MAC_TX_ACTIVE_POST_ACK;
   \   000015   7487         MOV     A,#-0x79
   \   000017   90....       MOV     DPTR,#macTxActive
   \   00001A   F0           MOVX    @DPTR,A
    580              MAC_RADIO_TX_CANCEL_ACK_TIMEOUT_CALLBACK();
   \   00001B                ; Setup parameters for call to function macCspTxCancelAckTimeoutCallback
   \   00001B   12....       LCALL   ??macCspTxCancelAckTimeoutCallback?relay
    581              HAL_EXIT_CRITICAL_SECTION(s);
   \   00001E   EE           MOV     A,R6
   \   00001F   A2E0         MOV     C,0xE0 /* A   */.0
   \   000021   92AF         MOV     0xa8.7,C
    582          
    583              /* a non-ACK was received when expecting an ACK, per spec transmit is over at this point */
    584              txComplete(MAC_NO_ACK);
   \   000023                ; Setup parameters for call to function txComplete
   \   000023   79E9         MOV     R1,#-0x17
   \   000025   12....       LCALL   ??txComplete?relay
   \   000028   8005         SJMP    ??macTxAckNotReceivedCallback_1
    585            }
    586            else
    587            {
    588              HAL_EXIT_CRITICAL_SECTION(s);
   \                     ??macTxAckNotReceivedCallback_0:
   \   00002A   EE           MOV     A,R6
   \   00002B   A2E0         MOV     C,0xE0 /* A   */.0
   \   00002D   92AF         MOV     0xa8.7,C
    589            }
    590          }
   \                     ??macTxAckNotReceivedCallback_1:
   \   00002F   7F01         MOV     R7,#0x1
   \   000031   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000034                REQUIRE _A_IEN0
    591          
    592          
    593          /*=================================================================================================
    594           * @fn          txComplete
    595           *
    596           * @brief       Transmit has completed.  Perform needed maintenance and return status of
    597           *              the transmit via callback function.
    598           *
    599           * @param       status - status of the transmit that just went out
    600           *
    601           * @return      none
    602           *=================================================================================================
    603           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    604          static void txComplete(uint8 status)
   \                     txComplete:
    605          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    606            /* reset the retransmit flag */
    607            txRetransmitFlag = 0;
   \   000007   7400         MOV     A,#0x0
   \   000009   90....       MOV     DPTR,#txRetransmitFlag
   \   00000C   F0           MOVX    @DPTR,A
    608          
    609            /* update tx state; turn off receiver if nothing is keeping it on */
    610            macTxActive = MAC_TX_ACTIVE_NO_ACTIVITY;
   \   00000D   7400         MOV     A,#0x0
   \   00000F   90....       MOV     DPTR,#macTxActive
   \   000012   F0           MOVX    @DPTR,A
    611          
    612            /* turn off receive if allowed */
    613            macRxOffRequest();
   \   000013                ; Setup parameters for call to function macRxOffRequest
   \   000013   12....       LCALL   ??macRxOffRequest?relay
    614          
    615            /* update transmit power in case there was a change */
    616            macRadioUpdateTxPower();
   \   000016                ; Setup parameters for call to function macRadioUpdateTxPower
   \   000016   12....       LCALL   ??macRadioUpdateTxPower?relay
    617          
    618            /*
    619             *  Channel cannot change during transmit so update it here.  (Channel *can* change during
    620             *  a receive.  The update function resets receive logic and any partially received
    621             *  frame is purged.)
    622             */
    623            macRadioUpdateChannel();
   \   000019                ; Setup parameters for call to function macRadioUpdateChannel
   \   000019   12....       LCALL   ??macRadioUpdateChannel?relay
    624          
    625            /* return status of transmit via callback function */
    626            macTxCompleteCallback(status);
   \   00001C                ; Setup parameters for call to function macTxCompleteCallback
   \   00001C   EE           MOV     A,R6
   \   00001D   F9           MOV     R1,A
   \   00001E   12....       LCALL   ??macTxCompleteCallback?relay
    627          }
   \   000021   7F01         MOV     R7,#0x1
   \   000023   02....       LJMP    ?BANKED_LEAVE_XDATA
    628          
    629          
    630          /**************************************************************************************************
    631           * @fn          macTxTimestampCallback
    632           *
    633           * @brief       This callback function records the timestamp into the receive data structure.
    634           *              It should be called as soon as possible after there is a valid timestamp.
    635           *
    636           * @param       none
    637           *
    638           * @return      none
    639           **************************************************************************************************
    640           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    641          void macTxTimestampCallback(void)
   \                     macTxTimestampCallback:
    642          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
    643            MAC_ASSERT(pMacDataTx != NULL); /* transmit structure must be there */
   \   000005   90....       MOV     DPTR,#pMacDataTx
   \   000008   E0           MOVX    A,@DPTR
   \   000009   6400         XRL     A,#0x0
   \   00000B   7004         JNZ     ??macTxTimestampCallback_0
   \   00000D   A3           INC     DPTR
   \   00000E   E0           MOVX    A,@DPTR
   \   00000F   6400         XRL     A,#0x0
   \                     ??macTxTimestampCallback_0:
   \   000011   7003         JNZ     ??macTxTimestampCallback_1
   \   000013                ; Setup parameters for call to function halAssertHandler
   \   000013   12....       LCALL   ??halAssertHandler?relay
    644          
    645            pMacDataTx->internal.timestamp  = macBackoffTimerCapture();
   \                     ??macTxTimestampCallback_1:
   \   000016                ; Setup parameters for call to function macBackoffTimerCapture
   \   000016   12....       LCALL   ??macBackoffTimerCapture?relay
   \   000019   8A..         MOV     ?V0 + 0,R2
   \   00001B   8B..         MOV     ?V0 + 1,R3
   \   00001D   8C..         MOV     ?V0 + 2,R4
   \   00001F   8D..         MOV     ?V0 + 3,R5
   \   000021   90....       MOV     DPTR,#pMacDataTx
   \   000024   E0           MOVX    A,@DPTR
   \   000025   F8           MOV     R0,A
   \   000026   A3           INC     DPTR
   \   000027   E0           MOVX    A,@DPTR
   \   000028   F583         MOV     DPH,A
   \   00002A   8882         MOV     DPL,R0
   \   00002C   A3           INC     DPTR
   \   00002D   A3           INC     DPTR
   \   00002E   A3           INC     DPTR
   \   00002F   A3           INC     DPTR
   \   000030   A3           INC     DPTR
   \   000031   78..         MOV     R0,#?V0 + 0
   \   000033   12....       LCALL   ?L_MOV_TO_X
    646            pMacDataTx->internal.timestamp2 = MAC_RADIO_TIMER_CAPTURE();
   \   000036                ; Setup parameters for call to function macMcuTimerCapture
   \   000036   12....       LCALL   ??macMcuTimerCapture?relay
   \   000039   8A..         MOV     ?V0 + 0,R2
   \   00003B   8B..         MOV     ?V0 + 1,R3
   \   00003D   90....       MOV     DPTR,#pMacDataTx
   \   000040   E0           MOVX    A,@DPTR
   \   000041   FA           MOV     R2,A
   \   000042   A3           INC     DPTR
   \   000043   E0           MOVX    A,@DPTR
   \   000044   F583         MOV     DPH,A
   \   000046   8A82         MOV     DPL,R2
   \   000048   A3           INC     DPTR
   \   000049   A3           INC     DPTR
   \   00004A   A3           INC     DPTR
   \   00004B   A3           INC     DPTR
   \   00004C   A3           INC     DPTR
   \   00004D   A3           INC     DPTR
   \   00004E   A3           INC     DPTR
   \   00004F   A3           INC     DPTR
   \   000050   A3           INC     DPTR
   \   000051   E5..         MOV     A,?V0 + 0
   \   000053   F0           MOVX    @DPTR,A
   \   000054   A3           INC     DPTR
   \   000055   E5..         MOV     A,?V0 + 1
   \   000057   F0           MOVX    @DPTR,A
    647          }
   \   000058   7F04         MOV     R7,#0x4
   \   00005A   02....       LJMP    ?BANKED_LEAVE_XDATA
    648          
    649          
    650          /**************************************************************************************************
    651           * @fn          macTxCollisionWithRxCallback
    652           *
    653           * @brief       Function called if transmit strobed on top of a receive.
    654           *
    655           * @param       none
    656           *
    657           * @return      none
    658           **************************************************************************************************
    659           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    660          void macTxCollisionWithRxCallback(void)
   \                     macTxCollisionWithRxCallback:
    661          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    662            macRxHaltCleanup();
   \   000004                ; Setup parameters for call to function macRxHaltCleanup
   \   000004   12....       LCALL   ??macRxHaltCleanup?relay
    663          }
   \   000007   D083         POP     DPH
   \   000009   D082         POP     DPL
   \   00000B   02....       LJMP    ?BRET

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for macTxSlottedDelay>`:
   \   000000   03           DB 3

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxHaltCleanup?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxHaltCleanup

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxFrame?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxFrame

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??txCsmaPrep?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    txCsmaPrep

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??txGo?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    txGo

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??txCsmaGo?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    txCsmaGo

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxFrameRetransmit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxFrameRetransmit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxStartQueuedFrame?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxStartQueuedFrame

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxChannelBusyCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxChannelBusyCallback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxDoneCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxDoneCallback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxAckReceivedCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxAckReceivedCallback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxAckNotReceivedCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxAckNotReceivedCallback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??txComplete?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    txComplete

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxTimestampCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxTimestampCallback

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??macTxCollisionWithRxCallback?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    macTxCollisionWithRxCallback
    664          
    665          
    666          
    667          /**************************************************************************************************
    668           *                                  Compile Time Integrity Checks
    669           **************************************************************************************************
    670           */
    671          #if (MAC_TX_ACTIVE_NO_ACTIVITY != 0x00)
    672          #error "ERROR! Zero is reserved value of macTxActive. Allows boolean operations, e.g !macTxActive."
    673          #endif
    674          
    675          /**************************************************************************************************
    676          */

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     macTxAckNotReceivedCallback        0      0      9
       -> macCspTxCancelAckTimeoutCallback
                                        0      0     18
       -> txComplete                    0      0     18
     macTxAckReceivedCallback           0      0      9
       -> macCspTxCancelAckTimeoutCallback
                                        0      0     18
       -> txComplete                    0      0     18
       -> txComplete                    0      0     18
       -> txComplete                    0      0     18
     macTxChannelBusyCallback           3      0      0
       -> halAssertHandler              4      0      0
       -> macRxOffRequest               4      0      0
       -> txComplete                    4      0      0
       -> txCsmaPrep                    4      0      0
       -> txCsmaGo                      4      0      0
     macTxCollisionWithRxCallback       2      0      0
       -> macRxHaltCleanup              4      0      0
     macTxDoneCallback                  0      0      9
       -> txComplete                    0      0     18
       -> macCspTxRequestAckTimeoutCallback
                                        0      0     18
     macTxFrame                         1      0     10
       -> halAssertHandler              0      0     20
       -> txComplete                    0      0     20
       -> macCspTxPrepSlotted           0      0     20
       -> halAssertHandler              0      0     20
       -> txCsmaPrep                    0      0     20
       -> halAssertHandler              0      0     20
       -> macMemWriteTxFifo             0      0     20
       -> txGo                          0      0     20
     macTxFrameRetransmit               2      0      0
       -> macTxFrame                    4      0      0
     macTxHaltCleanup                   2      0      0
       -> macCspTxReset                 4      0      0
       -> macTxInit                     4      0      0
     macTxInit                          2      0      0
     macTxStartQueuedFrame              0      0      9
       -> halAssertHandler              0      0     18
       -> txGo                          0      0     18
     macTxTimestampCallback             0      0     12
       -> halAssertHandler              0      0     24
       -> macBackoffTimerCapture        0      0     24
       -> macMcuTimerCapture            0      0     24
     txComplete                         0      0     19
       -> macRxOffRequest               0      0     18
       -> macRadioUpdateTxPower         0      0     18
       -> macRadioUpdateChannel         0      0     18
       -> macTxCompleteCallback         0      0     18
     txCsmaGo                           2      0      0
       -> macDataTxTimeAvailable        4      0      0
       -> txComplete                    4      0      0
       -> macCspTxGoCsma                4      0      0
     txCsmaPrep                         0      0     20
       -> macRadioRandomByte            0      0     20
       -> macCspTxPrepCsmaSlotted       0      0     20
       -> macCspTxPrepCsmaUnslotted     0      0     20
     txGo                               2      0     10
       -> macCspTxGoSlotted             4      0      0
       -> txCsmaGo                      4      0      0


   Segment part sizes:

     Function/Label                 Bytes
     --------------                 -----
     RFIM                              1
     _A_IEN0                           1
     RFST                              1
     macTxSlottedDelay                 1
     macTxActive                       1
     macTxType                         1
     macTxBe                           1
     macTxCsmaBackoffDelay             1
     nb                                1
     txSeqn                            1
     txAckReq                          1
     txRetransmitFlag                  1
     macTxInit                        23
     macTxHaltCleanup                 17
     macTxFrame                      356
     txCsmaPrep                       53
     txGo                             36
     txCsmaGo                         40
     macTxFrameRetransmit             25
     macTxStartQueuedFrame            62
     macTxChannelBusyCallback        133
     macTxDoneCallback                71
     macTxAckReceivedCallback         83
     macTxAckNotReceivedCallback      52
     txComplete                       38
     macTxTimestampCallback           93
     macTxCollisionWithRxCallback     14
     ?<Initializer for macTxSlottedDelay>
                                       1
     ??macTxInit?relay                 6
     ??macTxHaltCleanup?relay          6
     ??macTxFrame?relay                6
     ??txCsmaPrep?relay                6
     ??txGo?relay                      6
     ??txCsmaGo?relay                  6
     ??macTxFrameRetransmit?relay      6
     ??macTxStartQueuedFrame?relay     6
     ??macTxChannelBusyCallback?relay
                                       6
     ??macTxDoneCallback?relay         6
     ??macTxAckReceivedCallback?relay
                                       6
     ??macTxAckNotReceivedCallback?relay
                                       6
     ??txComplete?relay                6
     ??macTxTimestampCallback?relay    6
     ??macTxCollisionWithRxCallback?relay
                                       6

 
 1 096 bytes in segment BANKED_CODE
    90 bytes in segment BANK_RELAYS
     3 bytes in segment SFR_AN
     1 byte  in segment XDATA_I
     1 byte  in segment XDATA_ID
     8 bytes in segment XDATA_Z
 
 1 187 bytes of CODE  memory
     0 bytes of DATA  memory (+ 3 bytes shared)
     9 bytes of XDATA memory

Errors: none
Warnings: none
